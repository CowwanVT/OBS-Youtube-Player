<html>
  <head>
    <style>
      * { 
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background: none;
      }
    </style>
  </head>
  <body>
    <div id="info"></div>
    <div id="player"></div>

    <script async src="https://www.youtube.com/iframe_api"></script>

    <script>
      function info(txt) { return document.querySelector('#info').innerHTML = txt; }

      var url = new URL(window.location.href);
      console.log('url :' + url);
      var songID = url.searchParams.get('watch?v');
      var listID = url.searchParams.get('list');
      var volume = url.searchParams.get('volume') || 45;
      var width = url.searchParams.get('w') || 534;
      var height = url.searchParams.get('h') || 300;
      var random = url.searchParams.get('random') || true;
      var random = url.searchParams.get('random') || true;
      var loop = url.searchParams.get('loop') || true;
      var fondu = url.searchParams.get('fondu') || true;

      var hideVideo = false || url.searchParams.get('hide');
      if (hideVideo) { document.querySelector('#player').style.display = 'none'; }

      console.log(`insert : video = ${songID} | list = ${listID}`);

      function onYouTubeIframeAPIReady() {
        var player = new YT.Player('player', {
        width: width,              
        height: height, 

        playerVars: {
          autoplay: 1,        // Auto-play the video on load
          controls: 0,        // Show pause/play buttons in player
          showinfo: 0,        // Hide the video title
          modestbranding: 1,  // Hide the Youtube Logo
          loop: 1,            // Run the video in a loop
          fs: 0,              // Hide the full screen button
          cc_load_policy: 0,  // Hide closed captions
          iv_load_policy: 3,  // Hide the Video Annotations
          autohide: 1         // Hide video controls when playing
        },

        events: {
          'onReady': function() {
            // Get/Set volume params
            if (volume !== null) {
              player.setVolume(volume);
            } else {
              info(`Volume not specified, default (${volume}%) is applied, add "&volume=20" at the end of the link to change it.`);
              player.setVolume(volume);
            }
            // Get video type
            if (songID != null && listID != null) {
              console.log('Choosen video first, songs inside list will be read after')
              player.cueVideoById(songID);
              player.cuePlaylist({
                listType: 'playlist',
                list: listID
              });
            }
            if (listID != null && songID == null) {
              console.log('list only detected')
              player.cuePlaylist({
                listType: 'playlist',
                list: listID
              });
            }
            if (songID != null && listID == null) {
              console.log('Song only detected')
              player.cueVideoById(songID);
            }
          },
          'onStateChange': function (event) {
            switch(event.data){
              case -1:  // Not started
                info('Unable to start playing, the video might be unaivailable or double-check the link you just entered');
                var done = false;
                () => {
                  if (!done) {
                    done = true;
                    player.nextVideo();
                  }
                }
                break;
              case 0:   // Stopped
                console.log('Stopped');
                player.nextVideo()
                onAir();
                break;
              case 1:   // Playing
                document.querySelector('#info').innerHTML = '';
                console.log('Playing... ');
                onAir();
                break;
              case 2:   // Pause
                console.log('Paused...');
                onAir();
                break;
              case 3:
                console.log("Loading...");
                onAir();
                break;
              case 5:   // In queue
                console.log('In queue...');
                onAir();
                break
              default:
                console.log("default Play");
                onAir();
            }
          }
        }
      });

      function onAir() {
        if (loop) {
          console.log('Loop playlist activated')
          var loop = player.setLoop(true);
        }
        if (random) {
          console.log('Randomize video activated')
          var shuffle = player.setShuffle(true);
        }
        var state = player.playVideo();
        console.log(`On air`);
        if (fondu) {
          fondu()
        }
      }

      function fondu() {
        console.log("fondu")
        var videoLenght = Math.round(player.getDuration());
        var currentVideoTime = Math.round(player.getCurrentTime());
        var secondBeforeEnd = 5;

        for (var i=0, len=volume; i<len; i++) {
          setTimeout(function() {
            console.log(`Fondu in : vol=${i}`)
            player.setVolume(i);
          }, 1000);
        }

        setTimeout(function() {
          for (var i=volume, len=0; i>len; i--) {
            setTimeout(function() {
              console.log(`Fondu out : vol=${i}`)
              player.setVolume(i);
            }, 1000);
          }
          player.nextVideo();
        }, (videoLenght - secondBeforeEnd) * 1000);
      }
    }
    </script>
  </body>
</html>
